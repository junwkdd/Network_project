<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Profile</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="../stylesheets/profile.css">
</head>
<body>
    <div class="pic">
            <center><a><img src="http://blogfiles.naver.net/20151122_199/totlab_1448196836619lDz9x_PNG/%BB%E7%B6%F7.png" alt="Profile" width="10%"></a></center>
            <center><a href="#" class="button display-1">CHANGE PROFILE</a></center>
    </div>
    
    <div id="pricing-table" class="clear mt-5 col-12">
        <div class="plan col-2 ml-5">
            <h3>INFORMATION</h3>       
            <ul>
                <li>학번<input type="text" class="form-control form-control-sm"></li>
                <li>학과<input type="text" class="form-control form-control-sm"></li>
                <li>이메일<input type="text" class="form-control form-control-sm"></li>
            </ul>
        </div>

        <div class="plan col-9 ml-5">
            <h3>TIMELINE</h3>
            <script>alert(<%=post.length%>);</script>
            <% for(var i = 0; i < post.length; i++) { %>
                <div class="row mt-3 mb-3">
                    <div class="card col-sm-12 px-0">
                        <div class="card-body px-0">
                            <div class="media px-2">
                                <a href=""><img src="../images/porfile.png" class="mr-3" alt="..." style="width:64px;"></a>
                                <div class="media-body">
                                    <h5 class="mt-0"><a href=""><%=post[i].name%></a></h5>
                                    <%=post[i].date%>
                                    <hr style="border: 1px solid #343a40; background-color: #343a40">
                                    <div class="media mt-3">
                                        <div class="media-body">
                                            <%=post[i].content%>
                                        </div>
                                    </div>
                                </div>
                            </div> 
                        </div>
                        <div class="card-body pb-3">
                            <button type="button" class="btn btn-dark btn-sm mr-2" id="like__<%=post[i]._id%>">
                                <i class="far fa-heart mr-2" id="heart_<%=post[i]._id%>"></i>좋아요  
                                <span id="like_count_<%=post[i]._id%>">
                                    <% if(post[i].like !== undefined) { %>
                                        (<%=post[i].like%>)
                                    <% } %>
                                </span>
                            </button>
                            <button type="button" class="btn btn-dark btn-sm" onclick="comment_func_<%=post[i]._id%>()">
                                <i class="fa fa-comment mr-2"></i>댓글 
                                <span id="comment_count_<%=post[i]._id%>">
                                    <% if(post[i].comments !== undefined) { %>
                                        (<%=post[i].comments.length%>)
                                    <% } %>
                                </span>
                            </button>
                        </div>  
                        <%# 비동기 좋아요 추가 %>
                        <script>
                            var flag = 1;                            
                            $('#like__<%=post[i]._id%>').click(function() {
                                var post_id = '<%=post[i]._id%>';
                                $.ajax({
                                    url: '/',
                                    type: 'PUT',
                                    dataType:'json',
                                    data: {post_id: post_id, flag: flag},
                                    success: function(data) {
                                        console.log(data.result);
                                        $('#like_count_<%=post[i]._id%>').html('(' + data.result + ')');
                                        if(flag == 1) {
                                            $('#heart_<%=post[i]._id%>').css('color', 'red');
                                            flag = 0;
                                        } else {
                                            $('#heart_<%=post[i]._id%>').css('color', 'white');
                                            flag = 1;
                                        }
                                    },
                                    error: function(request, status, error) {
                                    }
                                });
                            });
                        </script>
                        <%# 댓글창 접었다 펼치기 짜잔~! %>
                        <script>
                            var flag = 1;
                            function comment_func_<%=post[i]._id%>() {
                                var comment_board = document.getElementById('comment_board_<%=post[i]._id%>');
                                if(flag == 1) {
                                    comment_board.style="display: block";
                                    flag = 0;
                                } else {
                                    comment_board.style="display: none";
                                    flag = 1;
                                }
                            }
                        </script>
                        <div class="card-footer" id="comment_board_<%=post[i]._id%>" style="display: none;">
                            <% if(post[i].comments !== undefined) { %>
                                <% for(var j = 0; j<post[i].comments.length; j++) { %>
                                    <div class="media pl-4 pt-3">
                                        <a href=""><img src="../images/porfile.png" alt="" class="mr-3 rounded-circle" style="width:40px;"></a>
                                        <div class="media-body" id="comment-body">
                                            <a href=""><h6><span id="post_name_<%post[i]._id%>"><%=post[i].comments[j].name%></span></a> <small><i id="post_date_<%post[i]._id%>"> <%=post[i].comments[j].date%></i></small></h6>
                                            <p id="post_content_<%post[i]._id%>" class="bg-white rounded-lg p-2"><%=post[i].comments[j].content%></p>
                                        </div>
                                    </div>
                                <% } %>
                            <% } %>
                            <%# 비동기 댓글 추가 %>
                            <script>
                                $('#enter_comment_<%=post[i]._id%>').click(function() {
                                    var post_id = '<%=post[i]._id%>';
                                    var comment = $('#comment_<%post[i]._id%>').val();
                                    $('#comment_<%post[i]._id%>').val('');
                                    $.ajax({
                                        url: '/',
                                        type: 'post',
                                        data: {post_id: post_id, comment: comment},
                                        success: function(res) {
                                            var data = res['result'];
                                            if(data !== undefined) {
                                                for(var j = 0; j < data.length; j++) {
                                                    var html = '<div class="media pl-4 pt-3">';
                                                        html += '<a href=""><img src="../images/porfile.png" alt="" class="mr-3 rounded-circle" style="width:40px;"></a>';
                                                        html += '<div class="media-body" id="comment-body">';
                                                        html += '<a href=""><h6><span id="post_name_<%post[i]._id%>">' + data[j].name + '</span></a> <small><i id="post_date_<%post[i]._id%>">' + data[j].date + '</i></small></h6>';
                                                        html += '<p id="post_content_<%post[i]._id%>" class="bg-white rounded-lg p-2">' + data[j].content + '</p>';
                                                        html += '</div>'
                                                        html += '</div>' 
                                                }
                                                $('#comment_count_<%=post[i]._id%>').html('(' + data.length + ')');
                                                $('#comment_board_<%=post[i]._id%>').append(html);
                                            }
                                        },  
                                        error: function(request, status, error) {
                                            alert("code:"+request.status+"\n"+"error:"+error);
                                        }
                                    })
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

</body>
</html>